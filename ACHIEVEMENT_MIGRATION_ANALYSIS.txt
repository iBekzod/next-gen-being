ACHIEVEMENT MIGRATION & GAMIFICATION SYSTEM - ANALYSIS

SUMMARY:
- Two conflicting achievement implementations exist
- OLD schema uses achievement_code (string), disabled migration
- NEW schema uses achievement_id (foreign key), active migration
- Production error occurs when code expects achievement_id column
- UserAchievement model incompatible with new schema

MIGRATIONS RELATED TO GAMIFICATION:

1. 2025_01_08_create_user_achievements_table.php.DISABLED
   Status: DISABLED (has .disabled extension)
   Date: January 8, 2025
   Content: achievements + user_achievements tables
   Schema: achievement_id as BIGINT FK
   NEVER RAN IN PRODUCTION

2. 2025_11_08_000002_create_badges_and_reputation_tables.php (ACTIVE)
   Date: November 8, 2025
   Creates:
   - achievements table
   - badges table
   - user_achievements table (achievement_id FK)
   - user_badges table (badge_id FK)
   - user_reputation table
   Includes if (!Schema::hasTable()) checks

3. 2025_11_10_000013_rename_achievement_code_to_achievement_id.php (ACTIVE)
   Date: November 10, 2025
   Attempts to handle old schema by renaming columns
   Only runs if achievement_code exists AND achievement_id doesn't

RELATED MIGRATIONS:
- 2025_11_08_000007: learning_paths table
- 2025_11_08_000008: learning_path_items table
- 2025_11_08_000009: ai_recommendations table
- 2025_11_08_000010: social_accounts table (OAuth)
- 2025_11_08_000011: live_reader_tracking (active_readers, reader_locations, reader_analytics)
- 2025_11_08_000005: OAuth columns to users table
- 2025_06_23: tutorial_progress table

EXPECTED SCHEMA (from 2025_11_08_000002):

user_achievements:
- id (BIGINT PK)
- user_id (BIGINT FK to users)
- achievement_id (BIGINT FK to achievements) <-- CRITICAL
- achieved_at (TIMESTAMP)
- metadata (JSON nullable)
- created_at, updated_at
- UNIQUE(user_id, achievement_id)
- FK constraints

achievements:
- id, name, description, slug (UNIQUE), icon, color, points, order
- is_active (BOOLEAN), requirements (JSON)
- timestamps

badges:
- Similar structure to achievements

user_badges:
- id, user_id FK, badge_id FK, earned_at
- UNIQUE(user_id, badge_id)

user_reputation:
- id, user_id (UNIQUE FK), points, posts_published, posts_liked
- comments_received, followers_count, engagement_score
- level, level_progress, timestamps

MODEL RELATIONSHIPS:

User.php (CORRECT):
- achievements() -> belongsToMany(Achievement::class, 'user_achievements')

Achievement.php (CORRECT):
- users() -> belongsToMany(User::class, 'user_achievements')

Badge.php (CORRECT):
- users() -> belongsToMany(User::class, 'user_badges')

UserReputation.php (CORRECT):
- user() -> belongsTo(User::class)

UserAchievement.php (WRONG - CONFLICTS):
- Uses achievement_code instead of achievement_id
- Has description field not in new schema
- Methods unlock() set achievement_code
- Checks where('achievement_code', 'first_post')

PRODUCTION ERROR:

Location: TutorialProgressService.php:180
Method: getUserLeaderboardPosition()

Code:
    ->join('achievements', 'achievements.id', '=', 'user_achievements.achievement_id')

Error: Column 'user_achievements.achievement_id' doesn't exist or is wrong type

Cause: Production DB either has:
- NO tables (migration 2025_11_08 didn't run)
- OLD schema with achievement_code (migration 2025_01_08 ran but disabled)
- Partial/corrupted schema

Similarly at: getTopLearners() line 196

SERVICE LAYER - TutorialProgressService.php:

checkAndAwardAchievements() (Lines 124-168):
- Gets all achievements
- Checks conditions from achievements.conditions JSON
- Calls: $user->achievements()->attach($achievement, ['earned_at' => now()])
- STATUS: Code is CORRECT for new schema

getUserLeaderboardPosition() (Lines 173-186):
- Joins user_achievements on achievement_id
- Sums achievements.points
- Returns user's rank position
- STATUS: Code expects achievement_id column

getTopLearners() (Lines 191-201):
- Joins user_achievements on achievement_id
- Groups and counts achievements
- STATUS: Code expects achievement_id column

CONFLICTING CODE:

File: app/Models/UserAchievement.php
Problems:
- fillable = ['user_id', 'achievement_code', 'description', 'metadata']
- Migration doesn't create these columns
- unlock() method sets achievement_code
- Where checks: where('achievement_code', 'first_post')
- Static getAchievements() returns old data structure

File: resources/views/livewire/user-reputation-card.blade.php:70
- {{ $achievement['achievement_code'] ?? 'Achievement' }}
- Expects achievement_code field

ROOT CAUSE:

1. Old migration (2025_01_08) was created with achievements
2. It was DISABLED - never executed
3. New migration (2025_11_08_000002) created with better schema
4. Code written for NEW schema expects achievement_id FK
5. OLD UserAchievement model still exists with OLD assumptions
6. Views/code expect achievement_code field

Production State:
- Tables don't exist (migration never ran properly), OR
- Old schema with achievement_code exists, OR
- Partial schema (some tables missing)

SAFE FIX APPROACH:

1. Check Production:
   - SHOW TABLES LIKE '%achievement%'
   - DESC user_achievements
   - DESC achievements

2. Create New Migration (2025_11_10_000014):
   - Ensure all tables exist with correct schema
   - Use if (!Schema::hasTable()) checks
   - Add/rename columns if needed

3. DELETE ConflictingCode:
   - Delete app/Models/UserAchievement.php
   - Remove achievement_code references

4. UPDATE Views:
   - Change achievement_code to achievement->name

5. Run Migrations:
   - php artisan migrate

FILES TO DELETE:
- app/Models/UserAchievement.php (INCOMPATIBLE)

FILES TO UPDATE:
- resources/views/livewire/user-reputation-card.blade.php:70

FILES THAT ARE CORRECT (NO CHANGES):
- app/Services/Tutorial/TutorialProgressService.php
- app/Models/User.php
- app/Models/Achievement.php
- app/Models/Badge.php
- app/Models/UserReputation.php
